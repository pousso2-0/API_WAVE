import { User } from "@prisma/client";
import { Request, Response } from "express";
import userService from "../services/userService";
import bcrypt from 'bcryptjs';
import prisma from "../config/prisma";
import jwt from 'jsonwebtoken';
import { IRequestAuth } from "../interfaces/AuthInterface";
import { blacklistToken } from "../security/blackList";

export default new class authController {

    async logout(req: Request, res: Response) {
        const userId: string = (req as IRequestAuth).user.userId;
        const token = req.headers['authorization']?.split(' ')[1]
        blacklistToken(token);
        res.clearCookie('token');
        res.status(200).json({ message: 'Deconnexion reussie', data: { userId }, error: false });
    }

    async login(req: Request, res: Response) {
        const { phone, password } = req.body;

        try {
            const user = await userService.phoneExist(phone);
            if (!user || !(await bcrypt.compare(password, user.passwordHash))) {
                return res.status(401).json({ message: 'Le numéro ou le mot de passe est incorrect.' });
            }

            const role = await userService.getRolename(user.roleId);

            // Génération des tokens
            const accessToken = jwt.sign(
                { userId: user.id, role: role },
                process.env.JWT_SECRET!,
                { expiresIn: '15m' }
            );

            const refreshToken = jwt.sign(
                { userId: user.id },
                process.env.JWT_REFRESH_SECRET!,
                { expiresIn: '7d' }
            );

            // Réponse avec les tokens
            res.status(200).json({
                data: { accessToken, refreshToken },
                message: 'Connexion réussie'
            });
        } catch (error) {
            res.status(500).json({ message: 'Erreur interne du serveur', error });
        }
    }

    async refreshToken(req: Request, res: Response) {
        const { refreshToken } = req.body;

        if (!refreshToken) {
            return res.status(401).json({ message: 'Refresh token requis' });
        }

        try {
            // Vérifier et décoder le refresh token
            const decoded = jwt.verify(refreshToken, process.env.JWT_REFRESH_SECRET!) as { userId: string };

            const user = await prisma.user.findUnique({ where: { id: decoded.userId } });
            if (!user) {
                return res.status(401).json({ message: 'Utilisateur non trouvé' });
            }

            const role = await userService.getRolename(user.roleId);

            // Génération d'un nouveau access token
            const newAccessToken = jwt.sign(
                { userId: user.id, role: role },
                process.env.JWT_SECRET!,
                { expiresIn: '15m' }
            );

            res.status(200).json({
                data: { accessToken: newAccessToken },
                message: 'Nouveau access token généré'
            });
        } catch (error) {
            console.error('Erreur lors du refresh token:', error);
            res.status(401).json({ message: 'Refresh token invalide ou expiré' });
        }
    }

}